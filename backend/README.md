# K Barbershop Backend (Python)\n\nPython FastAPI backend for the K Barbershop website, deployed to Google Cloud Run.\n\n## Overview\n\nThis backend handles:\n- Square Appointments API integration\n- Customer management\n- Booking creation and management\n- Team member (barber) profiles\n- Service catalog\n\n## Architecture\n\n- **Framework:** FastAPI\n- **Database:** Google Cloud Firestore\n- **Booking Provider:** Square Appointments API\n- **Deployment:** Google Cloud Run\n- **Container:** Docker\n\n## Key Files\n\n- `server.py` - Main FastAPI application\n- `square_service.py` - Square API integration (⚠️ RECENTLY FIXED)\n- `models.py` - Pydantic data models\n- `database.py` - Firestore database operations\n- `Dockerfile` - Container configuration\n- `cloudbuild.yaml` - Google Cloud Build configuration\n\n## Recent Fix (Oct 8, 2025)\n\n✅ **Fixed Square Customer API error**\n- Issue: Customer creation was failing with 'unrecognized field' error\n- Fix: Removed incorrect wrapper in `square_service.py` line 668\n- Status: Fixed and ready to deploy\n\nSee `../CRITICAL_FIX_SQUARE_CUSTOMER_API.md` for details.\n\n## Deployment\n\n### Build & Deploy to Cloud Run\n\n```bash\n# Build Docker image\ngcloud builds submit --config cloudbuild.yaml --project website-473417\n\n# Deploy to Cloud Run\ngcloud run deploy k-barbershop-backend \\\n  --image gcr.io/website-473417/k-barbershop-backend:latest \\\n  --platform managed \\\n  --region us-east4 \\\n  --allow-unauthenticated \\\n  --memory 512Mi \\\n  --cpu 1 \\\n  --timeout 300s \\\n  --project website-473417\n```\n\n### Quick Deploy Script\n\n```bash\nchmod +x deploy_fix.sh\n./deploy_fix.sh\n```\n\n## Environment Variables\n\nRequired environment variables (set in Cloud Run):\n\n```\nSQUARE_ACCESS_TOKEN=<your_token>\nSQUARE_LOCATION_ID=LCS4MXPZP8J3M\nGOOGLE_CLOUD_PROJECT=website-473417\n```\n\n## API Endpoints\n\n### Health Check\n```\nGET /api/\n```\n\n### Services\n```\nGET /api/services\nGET /api/services/{service_id}\nGET /api/services/categories\n```\n\n### Barbers\n```\nGET /api/barbers\nGET /api/barbers/{barber_id}/availability\n```\n\n### Bookings\n```\nPOST /api/bookings\nGET /api/bookings/{booking_id}\n```\n\n## Development\n\n### Local Setup\n\n```bash\n# Install dependencies\npip install -r requirements.txt\n\n# Copy environment variables\ncp .env.example .env\n# Edit .env with your credentials\n\n# Run locally\nuvicorn server:app --reload --port 8080\n```\n\n### Testing\n\n```bash\n# Test the API\ncurl http://localhost:8080/api/\n\n# Test booking creation\nchmod +x test_fix.sh\n./test_fix.sh\n```\n\n## Monitoring\n\n### Check Logs\n\n```bash\n# Recent errors\ngcloud logging read \\\n  \"resource.type=cloud_run_revision AND resource.labels.service_name=k-barbershop-backend AND severity>=ERROR\" \\\n  --limit 10 \\\n  --project website-473417\n\n# Tail logs\ngcloud logging tail \\\n  \"resource.type=cloud_run_revision AND resource.labels.service_name=k-barbershop-backend\" \\\n  --project website-473417\n```\n\n## Troubleshooting\n\n### Customer Creation Fails\n\nIf you see \"unrecognized field 'customer'\" errors:\n1. Verify `square_service.py` line ~510 has the fix applied\n2. Redeploy the backend\n3. Check logs for any remaining errors\n\n### Service Not Starting\n\nCheck:\n1. Environment variables are set correctly in Cloud Run\n2. Docker image built successfully\n3. Port 8080 is configured\n4. Memory limits are sufficient (512Mi minimum)\n\n## Related Repositories\n\n- **Frontend:** Website code (React/Next.js)\n- **ElevenLabs AI:** `kbarbershop/ai_receptionist` (Node.js)\n\n## Support\n\nFor issues or questions:\n1. Check Cloud Run logs\n2. Review recent commits\n3. See troubleshooting documentation\n